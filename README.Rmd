---
output: github_document
bibliography: references.bib
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# reluxr

<!-- badges: start -->

[![R-CMD-check](https://github.com/BradyAJohnston/reluxr/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/BradyAJohnston/reluxr/actions/workflows/R-CMD-check.yaml) [![CRAN status](https://www.r-pkg.org/badges/version/reluxr)](https://CRAN.R-project.org/package=reluxr) [![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)

<!-- badges: end -->

The goal of reluxr is to enable deconvolution of luminescencent plate-based experiments.
The implementation is based on the MatLab implementation from the paper titled '**Deconvolution of Luminescence Cross-Talk in High-Throughput Gene Expression Profiling'** [@mauri2019]

## Installation

You can install the development version of reluxr from [GitHub](https://github.com/) with:

``` r
if (!require(devtools)) install.packages("devtools")


devtools::install_github("BradyAJohnston/wellr")
devtools::install_github("BradyAJohnston/reluxr")
```

## Example

This is a basic example which shows you how to solve a common problem:

```{r example}
# library(reluxr)
library(wellr)
library(dplyr)

fl <- system.file(
   "extdata",
   "calibrate_tecan",
   "calTecan1.xlsx",
   package = "reluxr"
 )

name_repair <- function(x) vctrs::vec_as_names(x, quiet = TRUE, repair = "unique")

dat <- readxl::read_excel(
  path = fl, 
  skip = 43, 
  col_names = FALSE,
  .name_repair = name_repair
  )

dat |> 
  dplyr::mutate(
    group = cumsum(is.na(...3))
  ) |> 
  dplyr::group_by(group) |> 
  dplyr::mutate(
    ...1 = ...1[1]
  ) |> 
  dplyr::group_by(...1) |> 
  tidyr::nest() |> 
  dplyr::filter(!is.na(...1)) |> 
  dplyr::filter(stringr::str_detect(...1, "LUM|OD600")) |> 
  dplyr::mutate(
    data = purrr::map(data, tidyr::drop_na), 
    data = purrr::map(data, janitor::row_to_names, row_number = 1), 
    data = purrr::map(data, dplyr::mutate, dplyr::across(-c(1:2), as.numeric)),
    data = purrr::map(data, tidyr::pivot_longer,
                      cols = -c(1:2),
                      names_to = "well",
                      names_transform = wellr::well_format
                      )
  ) |> 
  tidyr::unnest(data) |> 
  janitor::clean_names() |> 
  dplyr::mutate(
    channel = stringr::str_extract(x1, "[^:]+")
  ) |> 
  dplyr::filter(!stringr::str_detect(well, "NA")) -> dat




```

```{r}
#| eval: false
fl <- system.file(
  "extdata",
  "calibrate_tecan",
  "calTecan1.xlsx",
  package = "reluxr"
)

dat <- plate_read_tecan(fl)


mat_d <- dat |>
  filter(signal != "OD600") |> 
  filter(time_s > 500) |> 
  rl_calc_decon_matrix("value", "time_s", ref_well = "E05", b_noise = 30)

```


## Lets create a new one.

```{r}

  
library(ggplot2)
data <- dat |>
  mutate(time_s = as.numeric(time_s)) |> 
  filter(channel != "OD600")

data |> dim()


mat_d_best <- data |>
  filter(channel != "OD600") |> 
  filter(time_s > 500) |> 
  rl_calc_decon_matrix("value", "time_s", ref_well = "E05", b_noise = 30)



data |>
  ungroup() |> 
  rl_adjust_plate(value, mat_d_best, time = time_s) |>
  summarise(value = mean(value), .by = well) |> 
  # mutate(value = if_else(value < 1, 1, value)) |> 
  rl_plot_plate(value, trans = log10) + 
  scale_fill_viridis_c(
    limits = c(1, NA)
  )




```

```{r}

rl_plot_time <- function(data, time, value, group = "well") {
  
  data <- dplyr::mutate(
    data, 
    time = {{ time }}, 
    value = {{ value }}, 
    group = {{ group }}
  )
  
  plt <- ggplot2::ggplot(
    data, 
    mapping = ggplot2::aes(
      x = time,
      y = value, 
      group = group
    )
  ) + 
    ggplot2::geom_line() + 
    ggplot2::scale_y_log10() + 
    ggplot2::theme_bw()
  
  plt
}

data |>
  ungroup() |> 
  rl_adjust_plate(value, mat_d_best, time = time_s) |>
  rl_plot_time(time_s, value, well) + 
  labs(
    x = "Time (s)", 
    y = "LUM"
  )


```

